<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>ref-type</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
</head>
<body>
<p>EN</p>
<ul>
<li>&lt;a href="https://ar.javascript.info/reference-type”</li>
<li>&lt;a href="reference-type.html”</li>
<li>&lt;a href="https://es.javascript.info/reference-type”</li>
<li>&lt;a href="https://fr.javascript.info/reference-type”</li>
<li>&lt;a href="https://it.javascript.info/reference-type” reference-type"</li>
</ul>
<!-- -->
<ul>
<li>&lt;a href="https://ko.javascript.info/reference-type”</li>
<li>&lt;a href="</li>
<li>&lt;a href="https://tr.javascript.info/”</li>
<li>&lt;a href="https://zh.javascript.info/reference-type”</li>
</ul>
<p>We want to make this open-source project available for people all around the world.</p>
<p><a href="translate.html">Help to translate</a> the content of this tutorial to your language!</p>
<p><a href="index.html" class="sitetoolbar__link sitetoolbar__link_logo"><img src="img/sitetoolbar__logo_en.svg" class="sitetoolbar__logo sitetoolbar__logo_normal" width="200" /><img src="img/sitetoolbar__logo_small_en.svg" class="sitetoolbar__logo sitetoolbar__logo_small" width="70" /></a></p>
<p><a href="ebook.html" class="buy-book-button"><span class="buy-book-button__extra-text">Buy</span>EPUB/PDF</a></p>
<p>Search</p>
<p>Search</p>
<p><a href="tutorial/map.html" class="map"></p>
<p><span class="share-icons__title">Share</span><a href="https://twitter.com/share?url=https%3A%2F%2Fjavascript.info%2Freference-type" class="share share_tw"></a>&lt;a href="https://www.facebook.com/sharer/sharer.php?s=100&amp;p%5Burl%5D=https%3A%2F%2Fjavascript.info%2Freference-type” </a></p>
<ol type="1">
<li><a href="index.html" class="breadcrumbs__link"><span class="breadcrumbs__hidden-text">Tutorial</span></a></li>
<li><span id="breadcrumb-1">&lt;a href="js.html” The JavaScript language</span></a></span></li>
<li><span id="breadcrumb-2">&lt;a href="js-misc.html” Miscellaneous</span></a></span></li>
</ol>
<p>30th April 2021</p>
<h1 id="reference-type">Reference Type</h1>
<p><span class="important__type">In-depth language feature</span></p>
<p>This article covers an advanced topic, to understand certain edge-cases better.</p>
<p>It’s not important. Many experienced developers live fine without knowing it. Read on if you want to know how things work under the hood.</p>
<p>A dynamically evaluated method call can lose <code>this</code>.</p>
<p>For instance:</p>
<p>&lt;a href="reference-type.html#” &lt;a href="reference-type.html#”</p>
<pre><code>let user = {
  name: &quot;John&quot;,
  hi() { alert(this.name); },
  bye() { alert(&quot;Bye&quot;); }
};

user.hi(); // works

// now let&#39;s call user.hi or user.bye depending on the name
(user.name == &quot;John&quot; ? user.hi : user.bye)(); // Error!</code></pre>
<p>On the last line there is a conditional operator that chooses either <code>user.hi</code> or <code>user.bye</code>. In this case the result is <code>user.hi</code>.</p>
<p>Then the method is immediately called with parentheses <code>()</code>. But it doesn’t work correctly!</p>
<p>As you can see, the call results in an error, because the value of <code>"this"</code> inside the call becomes <code>undefined</code>.</p>
<p>This works (object dot method):</p>
<pre><code>user.hi();</code></pre>
<p>This doesn’t (evaluated method):</p>
<pre><code>(user.name == &quot;John&quot; ? user.hi : user.bye)(); // Error!</code></pre>
<p>Why? If we want to understand why it happens, let’s get under the hood of how <code>obj.method()</code> call works.</p>
<h2 id="reference-type-explained"><a href="reference-type.html#reference-type-explained" id="reference-type-explained" class="main__anchor">Reference type explained</a></h2>
<p>Looking closely, we may notice two operations in <code>obj.method()</code> statement:</p>
<ol type="1">
<li>First, the dot <code>'.'</code> retrieves the property <code>obj.method</code>.</li>
<li>Then parentheses <code>()</code> execute it.</li>
</ol>
<p>So, how does the information about <code>this</code> get passed from the first part to the second one?</p>
<p>If we put these operations on separate lines, then <code>this</code> will be lost for sure:</p>
<p>&lt;a href="reference-type.html#” &lt;a href="reference-type.html#”</p>
<pre><code>let user = {
  name: &quot;John&quot;,
  hi() { alert(this.name); }
}

// split getting and calling the method in two lines
let hi = user.hi;
hi(); // Error, because this is undefined</code></pre>
<p>Here <code>hi = user.hi</code> puts the function into the variable, and then on the last line it is completely standalone, and so there’s no <code>this</code>.</p>
<p><strong>To make <code>user.hi()</code> calls work, JavaScript uses a trick - the dot <code>'.'</code> returns not a function, but a value of the special <a href="https://tc39.github.io/ecma262/#sec-reference-specification-type">Reference Type</a>.</strong></p>
<p>The Reference Type is a "specification type”. We can’t explicitly use it, but it is used internally by the language.</p>
<p>The value of Reference Type is a three-value combination <code>(base, name, strict)</code>, where:</p>
<ul>
<li><code>base</code> is the object.</li>
<li><code>name</code> is the property name.</li>
<li><code>strict</code> is true if <code>use strict</code> is in effect.</li>
</ul>
<p>The result of a property access <code>user.hi</code> is not a function, but a value of Reference Type. For <code>user.hi</code> in strict mode it is:</p>
<pre><code>// Reference Type value
(user, &quot;hi&quot;, true)</code></pre>
<p>When parentheses <code>()</code> are called on the Reference Type, they receive the full information about the object and its method, and can set the right <code>this</code> (<code>=user</code> in this case).</p>
<p>Reference type is a special "intermediary” internal type, with the purpose to pass information from dot <code>.</code> to calling parentheses <code>()</code>.</p>
<p>Any other operation like assignment <code>hi = user.hi</code> discards the reference type as a whole, takes the value of <code>user.hi</code> (a function) and passes it on. So any further operation "loses” <code>this</code>.</p>
<p>So, as the result, the value of <code>this</code> is only passed the right way if the function is called directly using a dot <code>obj.method()</code> or square brackets <code>obj['method']()</code> syntax (they do the same here). There are various ways to solve this problem such as <a href="bind.html#solution-2-bind">func.bind()</a>.</p>
<h2 id="summary"><a href="reference-type.html#summary" id="summary" class="main__anchor">Summary</a></h2>
<p>Reference Type is an internal type of the language.</p>
<p>Reading a property, such as with dot <code>.</code> in <code>obj.method()</code> returns not exactly the property value, but a special "reference type” value that stores both the property value and the object it was taken from.</p>
<p>That’s for the subsequent method call <code>()</code> to get the object and set <code>this</code> to it.</p>
<p>For all other operations, the reference type automatically becomes the property value (a function in our case).</p>
<p>The whole mechanics is hidden from our eyes. It only matters in subtle cases, such as when a method is obtained dynamically from the object, using an expression.</p>
<h2 id="tasks"><a href="reference-type.html#tasks" class="tasks__title-anchor main__anchor main__anchor main__anchor_noicon">Tasks</a></h2>
<h3 id="syntax-check"><a href="reference-type.html#syntax-check" id="syntax-check" class="main__anchor">Syntax check</a></h3>
<p><a href="task/check-syntax.html" class="task__open-link"></a></p>
<p><span class="task__importance" title="How important is the task, from 1 to 5">importance: 2</span></p>
<p>What is the result of this code?</p>
<pre><code>let user = {
  name: &quot;John&quot;,
  go: function() { alert(this.name) }
}

(user.go)()</code></pre>
<p>P.S. There’s a pitfall :)</p>
<p>solution</p>
<p><strong>Error</strong>!</p>
<p>Try it:</p>
<p>&lt;a href="reference-type.html#” &lt;a href="reference-type.html#”</p>
<pre><code>let user = {
  name: &quot;John&quot;,
  go: function() { alert(this.name) }
}

(user.go)() // error!</code></pre>
<p>The error message in most browsers does not give us much of a clue about what went wrong.</p>
<p><strong>The error appears because a semicolon is missing after <code>user = {...}</code>.</strong></p>
<p>JavaScript does not auto-insert a semicolon before a bracket <code>(user.go)()</code>, so it reads the code like:</p>
<pre><code>let user = { go:... }(user.go)()</code></pre>
<p>Then we can also see that such a joint expression is syntactically a call of the object <code>{ go: ... }</code> as a function with the argument <code>(user.go)</code>. And that also happens on the same line with <code>let user</code>, so the <code>user</code> object has not yet even been defined, hence the error.</p>
<p>If we insert the semicolon, all is fine:</p>
<p>&lt;a href="reference-type.html#” &lt;a href="reference-type.html#”</p>
<pre><code>let user = {
  name: &quot;John&quot;,
  go: function() { alert(this.name) }
};

(user.go)() // John</code></pre>
<p>Please note that parentheses around <code>(user.go)</code> do nothing here. Usually they setup the order of operations, but here the dot <code>.</code> works first anyway, so there’s no effect. Only the semicolon thing matters.</p>
<h3 id="explain-the-value-of-this"><a href="reference-type.html#explain-the-value-of-this" id="explain-the-value-of-this" class="main__anchor">Explain the value of "this”</a></h3>
<p><a href="task/why-this.html" class="task__open-link"></a></p>
<p><span class="task__importance" title="How important is the task, from 1 to 5">importance: 3</span></p>
<p>In the code below we intend to call <code>obj.go()</code> method 4 times in a row.</p>
<p>But calls <code>(1)</code> and <code>(2)</code> works differently from <code>(3)</code> and <code>(4)</code>. Why?</p>
<p>&lt;a href="reference-type.html#” &lt;a href="reference-type.html#”</p>
<pre><code>let obj, method;

obj = {
  go: function() { alert(this); }
};

obj.go();               // (1) [object Object]

(obj.go)();             // (2) [object Object]

(method = obj.go)();    // (3) undefined

(obj.go || obj.stop)(); // (4) undefined</code></pre>
<p>solution</p>
<p>Here’s the explanations.</p>
<ol type="1">
<li><p>That’s a regular object method call.</p></li>
<li><p>The same, parentheses do not change the order of operations here, the dot is first anyway.</p></li>
<li><p>Here we have a more complex call <code>(expression)()</code>. The call works as if it were split into two lines:</p>
<pre><code>f = obj.go; // calculate the expression
f();        // call what we have</code></pre>
<p>Here <code>f()</code> is executed as a function, without <code>this</code>.</p></li>
<li><p>The similar thing as <code>(3)</code>, to the left of the parentheses <code>()</code> we have an expression.</p></li>
</ol>
<p>To explain the behavior of <code>(3)</code> and <code>(4)</code> we need to recall that property accessors (dot or square brackets) return a value of the Reference Type.</p>
<p>Any operation on it except a method call (like assignment <code>=</code> or <code>||</code>) turns it into an ordinary value, which does not carry the information allowing to set <code>this</code>.</p>
<p><a href="currying-partials.html" class="page__nav page__nav_prev"><span class="page__nav-text"><span class="page__nav-text-shortcut"></span></span><span class="page__nav-text-alternate">Previous lesson</span></a><a href="bigint.html" class="page__nav page__nav_next"><span class="page__nav-text"><span class="page__nav-text-shortcut"></span></span><span class="page__nav-text-alternate">Next lesson</span></a></p>
<p><span class="share-icons__title">Share</span><a href="https://twitter.com/share?url=https%3A%2F%2Fjavascript.info%2Freference-type" class="share share_tw"></a>&lt;a href="https://www.facebook.com/sharer/sharer.php?s=100&amp;p%5Burl%5D=https%3A%2F%2Fjavascript.info%2Freference-type” </a></p>
<p><a href="tutorial/map.html" class="map"></p>
<h2 id="comments"><a href="reference-type.html#comments" id="comments">Comments</a></h2>
<p><span class="comments__read-before-link">read this before commenting…</span></p>
<ul>
<li>If you have suggestions what to improve - please <a href="https://github.com/javascript-tutorial/en.javascript.info/issues/new">submit a GitHub issue</a> or a pull request instead of commenting.</li>
<li>If you can’t understand something in the article - please elaborate.</li>
<li>To insert few words of code, use the <code>&lt;code&gt;</code> tag, for several lines - wrap them in <code>&lt;pre&gt;</code> tag, for more than 10 lines - use a sandbox (<a href="https://plnkr.co/edit/?p=preview">plnkr</a>, <a href="https://jsbin.com">jsbin</a>, <a href="http://codepen.io">codepen</a>…)</li>
</ul>
<p><a href="tutorial/map.html" class="map"></a></p>
<h4 id="chapter">Chapter</h4>
<ul>
<li><a href="js-misc.html" class="sidebar__link">Miscellaneous</a></li>
</ul>
<h4 id="lesson-navigation">Lesson navigation</h4>
<ul>
<li><a href="reference-type.html#reference-type-explained" class="sidebar__link">Reference type explained</a></li>
<li><p><a href="reference-type.html#summary" class="sidebar__link">Summary</a></p></li>
<li><a href="reference-type.html#tasks" class="sidebar__link">Tasks (2)</a></li>
<li><p><a href="reference-type.html#comments" class="sidebar__link">Comments</a></p></li>
</ul>
<p>Share</p>
<p><a href="https://twitter.com/share?url=https%3A%2F%2Fjavascript.info%2Freference-type" class="share share_tw sidebar__share"></a><a href="https://www.facebook.com/sharer/sharer.php?s=100&amp;p%5Burl%5D=https%3A%2F%2Fjavascript.info%2Freference-type" class="share share_fb sidebar__share"></a></p>
<p><a href="https://github.com/javascript-tutorial/en.javascript.info/blob/master/1-js/99-js-misc/04-reference-type" class="sidebar__link">Edit on GitHub</a></p>
<ul>
<li><a href="about.html" class="page-footer__link">about the project</a></li>
<li><a href="about.html#contact-us" class="page-footer__link">contact us</a></li>
<li><a href="terms.html" class="page-footer__link">terms of usage</a></li>
<li><a href="privacy.html" class="page-footer__link">privacy policy</a></li>
</ul>
</body>
</html>
